<link rel="stylesheet" href="/static/css/amazeui.datatables.css"/>
<style type="text/css">
    .am-alert{border-radius: 5px;padding:3px;}
</style>
<div class="crumb-wrap">
    <div class="crumb-list"><i class="icon-font"></i><a href="/public/index">首页</a><span class="crumb-step">&gt;</span><span class="crumb-name">作品管理</span></div>
</div>
<div class="result-wrap">
    <form name="myform" id="myform" method="post">
        <div class="result-title">
            <div class="result-list">
                <a href="addnode"><i class="icon-font"></i>新增节点</a>
            </div>
        </div>
        <div class="result-content">
            <table class="am-table am-table-bordered am-table-radius am-table-striped" width="100%" id="rbac-user-list">
                <thead>
                    <tr>
                        <th>名称</th>
                        <th>上级菜单</th>
                        <th>分组</th>
                        <th>URL</th>
                        <th>排序</th>
                        <th>状态</th>
                        <th>是否隐藏</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="data_body">
                    <tr>
                    </tr>
                </tbody>
            </table>
        </div>
    </form>
</div>

<div class="am-modal am-modal-confirm" tabindex="-1" id="del-confirm">
    <div class="am-modal-dialog">
        <div class="am-modal-hd">组别删除</div>
        <div class="am-modal-bd">
            你，确定要删除这条记录吗？
        </div>
        <div class="am-modal-footer">
            <input value="" type="hidden" class="data-modal-del">
            <span class="am-modal-btn data-am-modal-cancel">取消</span>
            <span class="am-modal-btn data-am-modal-confirm" onclick="deleteModel()">确定</span>
        </div>
    </div>
</div>

<!-- 修改消息模态框 -->
<div class="am-modal am-modal add-modal" tabindex="-1" id="edit-modal">
    <div class="am-modal-dialog" style="border-radius: 5px;">
        <div class="am-modal-hd" style="margin-bottom: 20px;"><h4>资源修改</h4>
            <a href="javascript: void(0)" class="am-close am-close-spin" data-am-modal-close>&times;</a>
        </div>
        <div class="am-modal-bd" style="border-bottom: none; font-size: 16px;">
            <form class="am-form am-form-horizontal">
                <input value="" type="hidden" id="editId">
                <div class="am-form-group am-form-group-sm">
                    <label for="doc-ipt-3" class="am-u-sm-3 am-form-label">显示名称：</label>
                    <div class="am-u-sm-9">
                        <input type="text" name="nodeTitle" class="am-radius" id="nodeTitle">
                    </div>
                </div>
                <div class="am-form-group am-form-group-sm">
                    <label for="doc-ipt-3" class="am-u-sm-3 am-form-label">资源名称：</label>
                    <div class="am-u-sm-9">
                        <input type="text" name="nodeName" class="am-radius" id="nodeName">
                    </div>
                </div>
                <div class="am-form-group am-form-group-sm">
                    <label for="doc-ipt-3" class="am-u-sm-3 am-form-label">资源分组：</label>
                    <div class="am-u-sm-9">
                        <select class="am-radius" id="nodeGroup" style="height:40px;" onchange="changeGroup()">
                            {{range $k,$v := .group}}
                                <option value="{{$v.Id}}">{{$v.Title}}</option>
                            {{end}}
                        </select>
                    </div>
                </div>
                <div class="am-form-group am-form-group-sm">
                    <label for="doc-ipt-3" class="am-u-sm-3 am-form-label">上级资源：</label>
                    <div class="am-u-sm-9">
                        <select class="am-radius" id="parentNode" style="height:40px;"></select>
                    </div>
                </div>
                <div class="am-form-group am-form-group-sm">
                    <label for="doc-ipt-3" class="am-u-sm-3 am-form-label">资源链接：</label>
                    <div class="am-u-sm-9">
                        <input type="text" name="nodeUrl" class="am-radius" id="nodeUrl">
                    </div>
                </div>
                <div class="am-form-group am-form-group-sm">
                    <label for="doc-ipt-3" class="am-u-sm-3 am-form-label">资源排序：</label>
                    <div class="am-u-sm-9">
                        <input type="text" name="sort" class="am-radius" id="sort">
                    </div>
                </div>
                <div class="am-form-group am-form-group-sm">
                    <label for="doc-ipt-3" class="am-u-sm-3 am-form-label">资源状态：</label>
                    <div class="am-u-sm-9" style="text-align: left;" id="status">
                        <label class="am-radio-inline">
                            <input type="radio" name="status" value="1"> 启用
                        </label>
                        <label class="am-radio-inline">
                            <input type="radio" name="status" value="2"> 禁用
                        </label>
                    </div>
                </div>
                <div class="am-form-group am-form-group-sm">
                    <label for="doc-ipt-3" class="am-u-sm-3 am-form-label">是否隐藏：</label>
                    <div class="am-u-sm-9" style="text-align: left;" id="hide">
                        <label class="am-radio-inline">
                            <input type="radio" name="hide" value="1"> 正常
                        </label>
                        <label class="am-radio-inline">
                            <input type="radio" name="hide" value="0"> 隐藏
                        </label>
                    </div>
                </div>
            </form>
        </div>
        <div class="am-modal-footer">
            <span class="am-btn am-radius am-btn-sm am-btn-default am-margin-right-sm" data-am-modal-close>取消</span>
            <span class="am-btn am-radius am-btn-sm am-btn-primary" onclick="editModal()">确定</span>
        </div>
    </div>
</div>
<script src="/static/js/jquery.dataTables.min.js"></script>
<script type="text/javascript">
    var oTable;
    $(function() {
        oTable = initTable();
    });
    function initTable() {
        var actionUrl = '/weserver/node/index?pid='+{{.pid}};
        var table = $('#rbac-user-list').dataTable({
            "bFilter": false,
            "bAutoWidth": false,
            "sPaginationType": 'full_numbers',
            "bPaginate": true,
            "bDestroy": true,
            "bProcessing": true,
            "sAjaxSource": actionUrl,
            "iDisplayLength": 10,
            "aLengthMenu": [
                [10, 15, 20, 50, -1],
                [10, 15, 20, 50, "All"]
            ],
            "bServerSide": true,
            "bSort": false,
            "aoColumns": [
                {"mDataProp": "Title",
                    "fnCreatedCell": function(nTd, sData, oData, iRow, iCol) {
                        $(nTd).html("<a href='/weserver/node/index?pid="+oData.Id+"'>"+sData+"</a>");
                    }
                },
                {"mDataProp": "PidName",},
                {"mDataProp": "GroupName",},
                {"mDataProp": "Url",},
                {"mDataProp": "Sort",},
                {"mDataProp": "Status",
                    "fnCreatedCell": function(nTd, sData, oData, iRow, iCol) {
                        if (sData == 1) {
                            $(nTd).html("<span class='am-alert am-alert-success'>正常</span>");
                        } else {
                            $(nTd).html("<span class='am-alert am-alert-danger'>禁用</span>");
                        }
                    }
                },
                {"mDataProp": "Hide",
                    "fnCreatedCell": function(nTd, sData, oData, iRow, iCol) {
                        if (sData == 1) {
                            $(nTd).html("<span class='am-alert am-alert-success'>正常</span>");
                        } else {
                            $(nTd).html("<span class='am-alert am-alert-danger'>隐藏</span>");
                        }
                    }
                },
                {"mDataProp": "Id",
                    "fnCreatedCell": function(nTd, sData, oData, iRow, iCol) {
                        $(nTd).html("<a title='节点编辑' onclick='editFun(" + oData.Id + ")'><span class='am-icon-pencil'></span></a>&nbsp;&nbsp;<a title='节点删除' href='#' onclick='deleteFun(" + oData.Id + ");'><span class='am-icon-trash'></span></a>");
                    }
                },
            ],
            "oLanguage": {
                "sProcessing": "正在加载中...",
                "sLengthMenu": "每页显示 _MENU_ 条记录，",
                "sZeroRecords": "没有数据！",
                "sEmptyTable": "表中无数据存在！",
                "sInfo": "_START_ - _END_ / 共 _TOTAL_ 条",
                "sInfoEmpty": "0 - 0 / 共 0 条",
                "sInfoFiltered": "",
                "sSearch": "搜索",
                "oPaginate": {
                    "sFirst": "首页",
                    "sPrevious": "上一页",
                    "sNext": "下一页",
                    "sLast": "末页"
                }
            },
            "dom": "<'row'<'col-sm-6'><'col-sm-6'>> <'row'<'col-sm-12'rt>> <'am-g'<'am-u-sm-6'li><'am-u-sm-6'p>>",
        });
        return table;
    }

    /**
    table刷新表格
    */
    $.fn.dataTableExt.oApi.fnReloadAjax = function(oSettings) {
        this.fnClearTable(this);
        this.oApi._fnProcessingDisplay(oSettings, true);
        var that = this;

        $.getJSON(oSettings.sAjaxSource, null, function(json) {
            for (var i = 0; i < json.aaData.length; i++) {
                that.oApi._fnAddData(oSettings, json.aaData[i]);
            }
            oSettings.aiDisplay = oSettings.aiDisplayMaster.slice();
            that.fnDraw(that);
            that.oApi._fnProcessingDisplay(oSettings, false);
        });
    }

    // 删除模态层
    function deleteFun(delid){
        $('#del-confirm').modal();
        $(".data-modal-del").val(delid);
    }
    // 删除方法
    function deleteModel(){
        var Id = $(".data-modal-del").val();
        $.ajax({
            url: '/rbac/node/delnoede',
            type: 'POST',
            data: {Id: Id},
            success: function(rsp){
                if (rsp.status){
                    alert(rsp.info);
                    oTable.fnReloadAjax(oTable.fnSettings());
                }else{
                    alert(rsp.info);
                }
            }
        })
    }
    // 模态退出
    $('#del-confirm').on('closed.modal.amui', function() {
        $(this).removeData('amui.modal');
        $(".data-modal-del").val("");
    });

    // 弹出修改模态层
    function editFun(id) {
        $("#edit-modal").modal();
        $('#editId').val(id);
        $.ajax({
            url : '/weserver/node/getNode',
            type : 'post',
            data : {Id : id},
            success : function(data) {
                $("#nodeTitle").val(data.Title);
                $("#nodeName").val(data.Name);
                $("#nodeGroup option[value='"+data.Group.Id+"']").prop('selected','true');
                $("#nodeUrl").val(data.Url);
                $("#sort").val(data.Sort);
                $("#status input[value='"+ data.Status +"']").attr("checked",'checked'); 
                $("#hide input[value='"+ data.Hide +"']").attr("checked",'checked'); 
                var infoText = "<option value='0'>顶级节点</option>";
                $.ajax({
                    url: '/weserver/node/getnodetree',
                    type: 'POST',
                    data: {Gid: data.Group.Id},
                    success: function(rsp){
                        if (rsp.status){
                            $.each(rsp.tree, function(i, item) {
                                infoText = infoText + "<option value='" + item.Id + "'>"+ item.text +"</option>";
                                $.each(item.menu, function(is, items) {
                                    infoText = infoText + "<option value='"+ items.Id +"'>&nbsp&nbsp┣━"+ items.text +"</option>";
                                });
                            });
                        }
                        $("#parentNode").html(infoText);
                        $("#parentNode option[value='"+data.Pid+"']").prop('selected','true');
                    }
                });
            }
        });
    }

    // 更改分组事件
    function changeGroup(){
        var groupId = $("#nodeGroup").val();
        var infoText = "<option value='0'>顶级节点</option>";
        $.ajax({
            url: '/weserver/node/getnodetree',
            type: 'POST',
            data: {Gid: groupId},
            success: function(rsp){
                if (rsp.status){
                    $.each(rsp.tree, function(i, item) {
                        infoText = infoText + "<option value='" + item.Id + "'>"+ item.text +"</option>";
                        $.each(item.menu, function(is, items) {
                            infoText = infoText + "<option value='"+ items.Id +"'>&nbsp&nbsp┣━"+ items.text +"</option>";
                        });
                    });
                }
                $("#parentNode").html(infoText);
            }
        });
    }

    // 修改资源方法
    function editModal() {
        var Id = $("#editId").val();
        var nodeName = $("#nodeName").val();
        var nodeTitle = $("#nodeTitle").val();
        var nodeGroup = $("#nodeGroup").val();
        var sort = $("#sort").val();
        var parentNode = $("#parentNode").val();
        var status = $("#status input[name='status']:checked").val();
        var hide = $("#hide input[name='hide']:checked").val();
        $.ajax({
            url : '/weserver/node/updatenode',
            type : 'post',
            data : {
                Id : Id,
                nodeTitle : nodeTitle,
                nodeName : nodeName,
                nodeGroup : nodeGroup,
                sort : sort,
                parentNode : parentNode,
                status : status,
                hide : hide
            },
            success : function(data) {
                if (data.status) {
                    alert(data.info);
                    $("#edit-modal").modal("close");
                    oTable.fnReloadAjax(oTable.fnSettings());
                } else {
                    alert(data.status);
                }
            }
        });
    }
</script>
